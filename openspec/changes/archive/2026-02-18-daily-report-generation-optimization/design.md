## Context

当前系统通过新浪财经 API 获取股票实时数据，生成每日报告。但存在以下问题：
- 没有交易日判断，周末和节假日也会触发报告生成
- 无法为历史日期生成报告
- 非交易日用户看到空报告

系统已有交易日时间判断函数（`is_cn_trading_time()`），但仅用于缓存决策，未用于报告生成逻辑。

## Goals / Non-Goals

**Goals:**
- 实现交易日历服务，支持交易日查询和缓存
- 优化报告生成逻辑，非交易日提示休市
- 支持为历史交易日生成报告（使用 K 线收盘价）
- 前端交互优化，显示交易日状态

**Non-Goals:**
- 不实现美股交易日历（仅支持 A 股）
- 不实现自动报告生成（定时任务）
- 不实现报告导出功能

## Decisions

### Decision 1: 交易日历数据源

**选择 AkShare API**

| 选项 | 优点 | 缺点 |
|------|------|------|
| AkShare | 免费、开源、无需注册 | 依赖 Python 库 |
| Tushare | 数据权威、稳定 | 需要注册 token |
| 硬编码 | 无外部依赖 | 维护成本高 |

**理由**：AkShare 开源免费，可直接调用，适合本项目规模。

### Decision 2: 交易日历缓存策略

**年度缓存 + 懒加载**

```
┌─────────────────────────────────────────┐
│           交易日历缓存流程               │
├─────────────────────────────────────────┤
│                                         │
│  查询日期 D 的交易日状态                 │
│         │                               │
│         ▼                               │
│  ┌─────────────┐                        │
│  │ 缓存中有 D   │──是──▶ 直接返回        │
│  │ 所在年数据？ │                        │
│  └─────────────┘                        │
│         │否                             │
│         ▼                               │
│  调用 AkShare 获取该年数据              │
│         │                               │
│         ▼                               │
│  存入数据库缓存                          │
│         │                               │
│         ▼                               │
│  返回结果                                │
│                                         │
└─────────────────────────────────────────┘
```

**理由**：交易日历年度更新，缓存一年有效；懒加载避免启动时加载大量数据。

### Decision 3: 历史数据获取方式

**使用 K 线 API 获取历史收盘价**

```python
# 当天报告：实时 API
price = fetch_realtime_data(symbol)  # 实时价格

# 历史报告：K 线 API
kline_data = fetch_kline_data(symbol, date)
price = kline_data[date]['close']  # 收盘价
```

**理由**：实时 API 不支持历史查询，K 线 API 可获取指定日期的收盘价。

### Decision 4: API 设计

| API | 方法 | 描述 |
|-----|------|------|
| `/trading-calendar/check` | GET | 检查日期是否为交易日 |
| `/trading-calendar/refresh` | POST | 刷新交易日历缓存 |
| `/snapshots/generate` | POST | 支持 `date` 参数，指定日期生成快照 |

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|---------|
| AkShare API 不稳定 | 增加重试机制（3 次）；降级到周末判断 |
| 历史数据获取失败 | 明确提示"该日期数据不可用" |
| 交易日历缓存过期 | 每年自动刷新；提供手动刷新接口 |
| K 线数据精度低于实时 | 前端明确标注"历史数据（收盘价）" |

## Migration Plan

1. **阶段一**：部署交易日历服务（无破坏性变更）
2. **阶段二**：更新报告生成逻辑（向后兼容）
3. **阶段三**：前端交互优化

无需数据迁移，新增表独立于现有数据。

## Open Questions

- 是否需要支持美股交易日历？（当前范围：否）
- 是否需要节假日提前通知？（当前范围：否）
