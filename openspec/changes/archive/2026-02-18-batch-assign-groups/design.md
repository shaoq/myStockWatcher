## Context

当前系统已具备股票与分组的多对多关系（通过 `stock_group_association` 中间表），以及股票多选和批量删除功能。用户可以通过编辑单个股票来修改其分组归属，但缺少批量操作能力。

**现有架构**：
- `Stock` ↔ `Group` 多对多关系
- 前端已有 `rowSelection` 多选机制
- 后端已有 `batch_update_stock_groups()` 函数（但为替换模式，且未暴露 API）

## Goals / Non-Goals

**Goals:**
- 实现批量归属股票到分组的功能
- 采用追加模式（保留原有分组）
- 支持自动创建不存在的分组
- 提供清晰的操作反馈（成功/跳过/失败）

**Non-Goals:**
- 不实现批量移出分组功能（已有 `batchRemoveFromGroup`）
- 不实现分组归属的撤销功能
- 不修改现有的分组管理逻辑

## Decisions

### 1. 归属语义：追加模式

**决定**：采用追加模式，而非替换模式。

**理由**：
- 多对多关系天然支持一只股票属于多个分组
- 用户可能从不同维度分类股票（如"科技板块"+"长期持有"）
- 替换模式可能导致意外丢失原有分类

**实现**：遍历每只股票时，将新分组追加到 `stock.groups` 列表中，而非替换

### 2. 分组选择 UI：Select tags 模式

**决定**：使用 Ant Design Select 组件的 `mode="tags"` 模式。

**理由**：
- 与现有编辑股票弹窗风格一致
- 支持多选现有分组
- 支持输入新分组名并回车创建
- 用户无需切换到其他页面创建分组

**替代方案**：
- Dropdown 菜单：只能单选，不支持多分组
- 独立的新建分组弹窗：增加操作步骤

### 3. 重复检测：自动跳过

**决定**：已在分组内的股票自动跳过，不报错。

**理由**：
- 重复添加是正常业务场景（批量操作时可能包含已在分组内的股票）
- 静默跳过比报错更友好
- 通过响应中的 `skipped_count` 告知用户

### 4. API 设计：使用分组名称而非 ID

**决定**：前端传递 `group_names`（字符串数组），后端负责查找/创建分组。

**理由**：
- 简化前端逻辑（无需先查询分组 ID）
- 支持自动创建分组（传入不存在的名称时创建）
- API 更直观易用

## Risks / Trade-offs

### 风险：并发归属操作

**风险**：多用户同时对同一批股票进行归属操作可能导致数据不一致。

**缓解**：当前系统为单用户使用，暂不处理。未来可考虑乐观锁或操作队列。

### 风险：分组名称冲突

**风险**：用户输入的分组名可能与现有分组重名。

**缓解**：使用分组名查找时，若已存在则复用，不创建重复分组。

### 权衡：API 灵活性 vs 简洁性

**选择**：优先简洁性，使用分组名称而非 ID。

**权衡**：牺牲了一些灵活性（无法指定分组的其他属性），但简化了前端实现和用户体验。

## Open Questions

无。所有设计决策已在探索阶段与用户确认。
